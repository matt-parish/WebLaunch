<html lang="en" dir="ltr">

	<head>
		<meta charset="UTF-8">
		<title>WebLaunch</title>

		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/Kindle.js"></script>	
		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/logging.js"></script> 
		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/eventing.js"></script> 
		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/object.js"></script>
		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/storage.js"></script>
		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/applicationManager.js"></script> 

		<!-- For orientation -->
		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/enums.js"></script>
		<script type="text/javascript" src="/var/local/mesquite/shared/javascripts/device.js"></script>
		
		<script type="text/javascript" src="pillowHelper.js"></script>
		<script type="text/javascript">
			var settings = undefined;
		</script>
		<script type="text/javascript" src="../settings.js"></script>
		<script type="text/javascript">
			//-----------------------------------------------------------------
			// Register our handling functions 
			Kindle.use(function(b) 
			{
				//=============================================================
				// App name and settings
				//=============================================================
			
				//-------------------------------------------------------------
				// Define the app name for later use
				var appName = 'com.PaulFreund.WebLaunch';
				var preventScreenSaverStateBackup  = null;

				//-------------------------------------------------------------
				// Default settings if none supplied			
				var sessionSettings = { 
					url: 'error.html',
					title: 'WebLaunch',
					hideStatusbar: false,
					enableWireless: false,
					powerButtonClose: true,
					enablePreventScreenSaver: false,
					landscape: false
				};

				var hourlyTimeout = null;
				var toggleTimeout = null;
				var batteryTimeout = null;
				
				//-------------------------------------------------------------
				// Copy supplied config properties		
				if( settings !== undefined && typeof(settings) === 'object' )
				{
					for( var key in sessionSettings )
					{
						if( !sessionSettings.hasOwnProperty(key) ) { continue; }
						if( !settings.hasOwnProperty(key) ) { continue; }
						sessionSettings[key] = settings[key];
					}
				}	

				//=============================================================
				// Helper functions
				//=============================================================

				//-------------------------------------------------------------
				// Small helper function to call runAsDefaultStatusBar 
				function pillowRun(fkt, callback) 
				{ 
					pillowHelper.Run('default_status_bar', appName, fkt, callback); 
				}
				
				//-------------------------------------------------------------
				// Get the initial state of preventScreenSaver and change it 		
				function requestPreventScreenSaverState()
				{
					// Get state
					pillowRun(
						"return nativeBridge.getIntLipcProperty('com.lab126.powerd', 'preventScreenSaver');", 
						function(state)
						{
							if( typeof(state) === 'number' && (state === 0 || state === 1 ) )
							{
								preventScreenSaverStateBackup = state;
								setPreventScreenSaverState(1);
							}
						}
					);
				}
				
				//-------------------------------------------------------------
				// Get the initial state of preventScreenSaver and change it 		
				function setPreventScreenSaverState(state)
				{				
					if( typeof(state) === 'number' && (state === 0 || state === 1 ) )
					{
						pillowRun(	
							"nativeBridge.setIntLipcProperty('com.lab126.powerd','preventScreenSaver',"
							+state
							+");"
						); 
					}
				}
				
				//-------------------------------------------------------------
				// Close the application
				function exitApplication()
				{
					// Close the application
					if( sessionSettings.powerButtonClose )
						pillowRun("nativeBridge.setLipcProperty('com.lab126.appmgrd', 'stop', '"+appName+"');");
				}				
				
				//-------------------------------------------------------------
				// Register power button callback
				function registerPowerButtonCallback()
				{			
					// Register Callback and watch for power button
					pillowHelper.RegisterStatusBarEventCallback(appName, 
						function(value) 
						{
							if( value.eventName && value.eventName === 'yoshibutton')
								exitApplication();
						}
					);
					
					// Request powerbutton event
					pillowHelper.RequestStatusBarEvent(
						appName, 
						'com.lab126.system.event', 
						'yoshibutton'
					);
				}			

				function toggleWifiHourly() {
					// turn it on
					kindle.net.setWirelessState('on');

					// turn it off in 1 minutes
					toggleTimeout = setTimeout(function() {
						kindle.net.setWirelessState('off');
					}, 1 * 60 * 1000)

					// send a battery update in 10 seconds
					batteryTimeout = setTimeout(function() {
						pillowRun(
							"return nativeBridge.getIntLipcProperty('com.lab126.powerd', 'battLevel');",
							function(state)
							{
								var xhttp = new XMLHttpRequest();
								xhttp.open("GET", "myurl?battery=" + state);
								xhttp.send();
							}
						);
					}, 10 * 1000)

					// get current time, and how far away the next full hour is
					// (e.g. 10:00:00, 11:00:00, ....)
					var now = new Date()
					var nextHourExactlyInMs = (new Date()).setHours(now.getHours() + 1, 0, 0, 0)

					// set another call of toggleWifi for the next hour mark
					// (e.g. 09:59:00, 10:59:00, ...)
					hourlyTimeout = setTimeout(toggleWifiHourly, nextHourExactlyInMs - now.getTime())
				}
						
				//=============================================================
				// Event handlers
				//=============================================================

				//-------------------------------------------------------------
				// Open application
				function openApp(state)
				{
					registerPowerButtonCallback();
					
					if( sessionSettings.enablePreventScreenSaver )
						requestPreventScreenSaverState();
					
					// Enable networking if desired
					// if( sessionSettings.enableWireless )
					// 	kindle.net.setWirelessState('on');

					// turn on wifi for the webpage to load hourly
					toggleWifiHourly()

					// Load url 
					kindle.chrome.createContentWindow(sessionSettings.url);
					
					// Set window title
					kindle.chrome.setTitleBar('', sessionSettings.title);
					
					// Remove statusBar if desired
					if( sessionSettings.hideStatusbar )
						pillowRun("nativeBridge.hideMe();");				

					// Set orientation to landscape if desired
					if ( sessionSettings.landscape )
						b.device.orientation = b.enums.orientations.landscape;
				}

				//-------------------------------------------------------------
				// restore status bar on close
				function closeApp() 
				{ 
					if (hourlyTimeout !== null) {
						clearTimeout(hourlyTimeout);
					}
					if (toggleTimeout !== null) {
						clearTimeout(toggleTimeout);
					}
					if (batteryTimeout !== null) {
						clearTimeout(batteryTimeout);
					}

					if( preventScreenSaverStateBackup !== null )
						setPreventScreenSaverState(preventScreenSaverStateBackup);
				
					pillowHelper.UnRegisterStatusBarEventCallback(appName);
					pillowRun("nativeBridge.showMe();"); 
				}

				//=============================================================
				// Registration of event handlers
				//=============================================================

				b.applicationManager.addEventListener('go', openApp);
				b.applicationManager.addEventListener('unload', closeApp);
				b.applicationManager.addEventListener('pause', closeApp);
			});

		</script>
	</head>
	
	<body>
	</body>

</html>
